# Proxy

## HttpPlain代理

### HTTP1的协议结构

* 请求体

```text

+--------+---------+---------+---------+---------+------+
| METHOD | [SPACE] | URI/URL | [SPACE] | VERSION | CRLF |
+---------------+----------+---------------------+------+
|      KEY      | :[SPACE] |       VALUE         | CRLF |
+---------------+----------+---------------------+------+
|      KEY      | :[SPACE] |       VALUE         | CRLF |
+---------------+----------+---------------------+------+
|      KEY      | :[SPACE] |       VALUE         | CRLF |
+------+------------------------------------------------+
| CRLF |
+-------------------------------------------------------+
|                       [BODY]                          |
+-------------------------------------------------------+

```

* 响应体

 ```text
+---------+---------+------+---------+---------+------+
| VERSION | [SPACE] | CODE | [SPACE] | PHRASES | CRLF | 
+---------------+----------+-------------------+------+
|      KEY      | :[SPACE] |       VALUE       | CRLF |
+---------------+----------+-------------------+------+
|      KEY      | :[SPACE] |       VALUE       | CRLF |
+---------------+----------+-------------------+------+
|      KEY      | :[SPACE] |       VALUE       | CRLF |
+------+------------------------------------------------+
| CRLF |
+-----------------------------------------------------+
|                       [BODY]                        |
+-----------------------------------------------------+

```

### HTTPS代理建立

HTTPS是加密的，和HTTP的建立过程是不一致的

* 请求体

```text
+---------+---------+--------+---------+---------+------+
| CONNECT | [SPACE] | [ADDR] | [SPACE] | VERSION | CRLF |
+---------------+----------+---------------------+------+
|      Host     | :[SPACE] |       [Host]        | CRLF |
+---------------+----------+---------------------+------+
| CRLF |

CONNECT www.baidu.com HTTP/1.1
Host: www.baidu.com

```

* 响应体

```text
+---------+---------+------+---------+---------+------+
| VERSION | [SPACE] | CODE | [SPACE] | PHRASES | CRLF | 
+------+----------------------------------------------+
| CRLF |

HTTP/1.1 200 OK
```

## Socks5代理

### Socks5握手阶段

```text
BYTE       1     2     NBite
        +-----+-----+---------+
CLIENT  | VER | LEN | METHODS |  
        +-----+-----+---------+
           1       2
        +-----+--------+
SERVER  | VER | METHOD |
        +-----+--------+
```

* METHOD认证方法，`0x00`无认证，`0x01`GSSAPI，`0x02`用户名和密码认证，`0x03-0x7F`IANA所分配，`80-FE`保留，`FF`没有支持的方法

### Socks5认证阶段

```text
BYTE       1     2      NBite     N       NBite
        +-----+-----+----------+-----+----------+
CLIENT  | VER | LEN | USERNAME | LEN | PASSWORD |
        +-----+-----+----------+-----+----------+
           1       2
        +-----+--------+
SERVER  | VER | STATUS |
        +-----+--------+
```

### Socks5请求阶段

```text
BYTE       1     2     3     4     NBite  2Bite  
        +-----+-----+-----+------+------+------+ 
CLIENT  | VER | CMD | RSV | ATYP | ADDR | PORT | 
        +-----+-----+-----+------+------+------+ 
BYTE       1     2     3     4     NBite  2Bite  
        +-----+-----+-----+------+------+------+
SERVER  | VER | REP | RSV | ATYP | ADDR | PORT |
        +-----+-----+-----+------+------+------+
```

* CMD命令类型，`0x01`连接，`0x2`绑定，`0x3`UDP转发
* REP应答字段，`0x00`成功，`0x01`socks服务失败，`0x02`不允许的连接，`0x03`网络不可达，`0x05`连接被拒绝，`0x06`TTL超时，`0x07`
  不支持的CMD，`0x08`不支持的地址类型
* ATYP地址类型，`0x01`IPv4，`0x03`域名（第一个字节为长度），`0x04`IPv6

## HTTPS流量解密
* 中间代理的实现HTTPS解密
```text
 +--------+      +-------+      +--------+
 | CLIENT | ←--→ | PROXY | ←--→ | SERVER |
 +--------+   ↑  +-------+   ↑  +--------+
              |              |
           +-----+        +-----+ 
           | tls |        | tls |  
           +-----+        +-----+ 
```
`PROXY`与`CLIENT`之间的使用自签证书即可解密